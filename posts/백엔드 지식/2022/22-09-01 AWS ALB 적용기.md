---
title: AWS ALB 적용기
date: 2022-09-01
---

## ELB(Elastic Load Balancer) 알아보기

- 네트워크 트래픽을 분산하여 애플리케이션 확장성 개선
  - AWS가 늘 강조하는 가용성에 있어서, 매우 중요한 역할을 하는 서비스입니다.
  - 이름 그대로, 트래픽을 분산하는 로드밸런서를 매우 손쉽게 추가할 수 있는 서비스입니다.
- 인증서 관리, SSL/TLS 관리를 매우 쉽게 할 수 있으며, EC2 인스턴스 등을 통해 웹 서비스를 배포할 때 NGINX와 certbot을 통해 인증서 관리를 할 수 있는데, Application Load Balancer를 사용한다면 ALB와 EC2를 통신하게 하는 방식으로, 매우 손쉽게 인증서 관리를 ELB에 맡길 수 있습니다.
  - \* EC2는 ALB와 통신을 하기 위한 보안 정책만 설정하면 되므로, EC2 인스턴스를 완전히 클라이언트와 분리할 수 있습니다.
- Route53에서 발급받은 도메인을 ACM을 통해 AWS에서 인증서를 발급받을 수 있고, 해당 인증서를 ALB에 추가할 수 있습니다. (클릭 몇 번만으로!) 그리고 ALB에 발급되는 도메인을 인증서를 발급받은 도메인과 연결만 시키면 웹서버에 도메인 + 인증서 설정을 끝낼 수 있습니다.

## 실습

### 0. VPC, ACM, Route53 를 설정합니다.

- 가용 영역이 두 개 이상인 VPC를 만들어 둡니다. (\*자세한 내용 생략)
- Route53에서 도메인을 등록하고, ACM을 통해 인증서를 발급받습니다. (\*자세한 내용 생략)

### 1. 보안 그룹을 새로 만듭니다.

- `alb-security-group`: ALB를 위한 보안 그룹으로, 실제 클라이언트와 통신을 하는 영역이므로 HTTP와 HTTPS 인바운드를 허용시킵니다.
  - **Inbound rules**
    - HTTP (80) - ANY IPv4
    - HTTPS (443) - ANY IPv4
- `ec2-target-group-security-group`: ALB와 통신하는 EC2 타겟 그룹을 위한 보안 그룹으로, 서버가 어떤 포트로 열려있는지에 따라 설정을 다르게 해주어야 합니다. (\* 간혹 여기를 80포트로 고정시키고 왜 안되는지에 대해 의문을 갖는 사람들이 있다..)
  - **Inbound rules**
    - SERVER APP PORT (\*80) - `alb-security-group`
      - \* 나 같은 경우는 일반적으로 NGINX를 통해 80포트로 노출시키므로, 해당 설정을 고정시키는 편입니다.
      - 여기서 설정한 포트는 타겟그룹을 만들 때 `Protocol:Port` 를 설정할 때의 값입니다.
    - (선택) SSH (22) - 최대한 제한된 IP CIDR 그룹
      - EC2에 SSH로 접근하고 싶다면 SSH 인바운드를 설정해두는 편이 좋습니다.

### 2. EC2 인스턴스 설정

서버 애플리케이션을 올려둘 EC2를 설정합니다. 다음과 같은 설정을 마치며 됩니다.

- 80 포트로 헬스체크가 가능한 엔드포인트가 있는 웹 서버
  - 헬스체크가 가능한 엔드포인트를 열어두면 이 다음 과정에서 타겟 그룹을 생성시 EC2와 정상적으로 연동되었는지 확인할 수 있을 뿐 아니라, 실제 서버 운영시 장애여부를 확인할 수 있습니다.

### 3. Target Group 생성

ALB 설정을 위해 ALB와 연결할 타겟 그룹을 생성해야 합니다.

1. EC2와 연결하므로 타입은 `Instances`로 설정해줍니다.
   ![](public/create_aws_target_group_1.png)

2. 타겟 그룹이름은 적절히 명시적으로 지어주면 됩니다. 여기서 protocol, port 부분은 앞서 말했던 부분인데, ALB에서 보낼 타겟 프로토콜과 포트입니다. 더 자세히 이야기하면 EC2에서 80포트로 서버를 실행중이라면 해당 포트로 ALB의 트래픽을 보내줘야합니다. 이를 위해 적는 공간이라고 생각하면 됩니다. 헬스체크는 앞서 말들어둔 엔드포인트를 적어주면 됩니다.

![](public/create_aws_target_group_2.png)

### 4. Target Group 확인

1. 만약 정상적으로 생성이 되었다면, 타겟 그룹에서 `Details` 를 확인했을 때 `Healthy`에 숫자 (아마도 1)이 표시됩니다.

![](public/target_group_healthy.png)

### 5. Load Balancers 생성

드디어 Application Load Balancer를 생성해보도록 하겠습니다.

1. Application Load Balancer를 선택합니다.
   ![](public/how_ALB_work.png)

2. 이름만 명시적으로 작성하고, 나머지는 읽어보고 넘어가면 됩니다. 내부 네트워킹을 위한 설정 등이 있는데, 일반적인 경우에는 필요하지 않으므로 알아만 두겠습니다.

![](public/alb_basic_config.png)

3. 만든 VPC와 ALB와 맞닿는 가용영역과 서브넷을 설정해주면 됩니다. 여기서 지금 우리 EC2는 하나의 AZ에만 위치하는데, 이렇게 설정하는게 맞는가에 대한 의문이 들 수 있는데, 로드밸런서의 기본 역할이 가용성 확보이므로 그런가보다 하면 된다. 그리고 우리는 타겟 그룹을 통해 통신 방법을 명시해주었기 때문에, 알아서 잘 될 것입니다!.. 다만 VPC 내에서 서브넷을 가용영역별로 설정을 해줘야한다는 점 꼭 기억하면 됩니다.

![](public/network_mapping.png)

4. 보안그룹은 앞서 만든 `alb-security-group`으로 설정하면 됩니다.
5. Listeners and routing 영역이 있는데, 여기서 설정한 값은 ALB가 듣는(받는) 트래픽에 대한 값입니다. 여기서 들어온 트래픽을 타겟 그룹에서 설정한 프로토콜과 포트로 인스턴스에 전달하게 되는거지요. 이번에는 HTTP와 HTTPS를 적용할 것이므로 HTTP와 HTTPS로 타겟 그룹에 포워딩하게 합니다.
6. 위에서 HTTPS를 추가했다면 인증서를 설정하는 부분이 생기는데, 이 때 앞서 만든 인증서를 추가하면 됩니다.
7. Summary를 통해 정상적으로 작성되었는지 마지막으로 체킹하고, 생성합니다.

### 6. Load Balancer 확인

ALB를 생성하게 되면 EC2에서 도메인을 생성시켜주므로, 해당 도메인으로 접속했을 때 정상적으로 서버와 통신이 되면 OK이 입니다. (\* "Load balancer" > "Basic Configuration" > "DNS name" 확인)

### 7. Route53 연결

드디어 우리가 원했던 도메인 + 인증서 설정을 마무리할 수 있게 됩니다. 실제로 작업하면 얼마 안되는 분량인데, 정리하자니 정말 길게 느껴지는 것 같습니다. 큰 맥락을 익히시게 된다면 다음 작업때 순식간에 해내실 수 있을 것이라 믿습니다. 마지막으로 Route53에서 A name을 입력해 도메인을 연결해보겠습니다.

![](public/domain_record.png)

1. 인증서를 발급받은 도메인에 대해, 레코드 타입을 "A"로 설정한 뒤, Alias 설정을 킵니다.
2. 이후, Network Load Balancer를 찾은 뒤, 지역을 설정하면 위에서 만든 ALB를 선택할 수 있습니다.
3. 위 과정을 마치면 해당 도메인으로 접속할 수 있게 됩니다!

### 8. (옵션) HTTP to HTTPS

하지만 해당 도메인으로 HTTP로 접속해보면 이 또한 정상적으로 접근이 되는 것을 확인할 수 있습니다. HTTPS만을 활용하기 위해 일반적인 상용 서비스는 HTTP로 접근시 HTTPS로 리다이렉션을 시켜주는 방식을 택하고 있습니다. 이 방식을 ALB에서 사용하는 방법을 알아보도록 하겠습니다.

1. 로드밸런서의 Listeners 설정으로 들어가서 HTTP: 80 옵션을 Edit 합니다.
2. 아래와 같은 페이지가 나오고, 기존에 존재하는 actions을 삭제 한뒤, Redirect action을 추가합니다. HTTPS (443)으로 리다이렉팅할 것이므로 아래와 같이 설정해주기만 하면 됩니다.
3. 이제 잠시 기다리면 `http`로 접근시 리다이렉팅이 되는 것을 확인할 수 있습니다.

![](public/http_to_https.png)
